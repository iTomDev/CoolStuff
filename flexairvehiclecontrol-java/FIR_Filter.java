/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package flexairvehiclecontrol;

import java.util.*;

/**
 *
 * @author Thomas Pile, 12th Jan 2017
 */
public class FIR_Filter 
{
    // 20th order, 15Hz cutoff, Fs=1/0.008ms, 80dB atten
    // int order = 21;
    double[] c1 = {   0.0004,
                    -0.0009,
                    -0.0048,
                    -0.0004,
                     0.0173,
                     0.0145,
                    -0.0380,
                    -0.0659,
                     0.0589,
                     0.3026,
                     0.4323,
                     0.3026,
                     0.0589,
                    -0.0659,
                    -0.0380,
                     0.0145,
                     0.0173,
                    -0.0004,
                    -0.0048,
                    -0.0009,
                     0.0004};
    
    // 20th order, 10Hz cutoff, Fs=1/0.008ms, 80dB atten
    // int order = 21;
    double[] c2 = {  -0.0007,
                    -0.0010,
                     0.0029,
                     0.0101,
                     0.0064,
                    -0.0211,
                    -0.0487,
                    -0.0150,
                     0.1138,
                     0.2772,
                     0.3529,
                     0.2772,
                     0.1138,
                    -0.0150,
                    -0.0487,
                    -0.0211,
                     0.0064,
                     0.0101,
                     0.0029,
                    -0.0010,
                    -0.0007};
    
    // 20th order, 15Hz cutoff, Fs=1/0.01ms, 80dB atten
    // int order = 21;
    double[] c3 = {  0.0011,
                    0.0022,
                   -0.0040,
                   -0.0103,
                    0.0090,
                    0.0313,
                   -0.0150,
                   -0.0829,
                    0.0200,
                    0.3098,
                    0.4781,
                    0.3098,
                    0.0200,
                   -0.0829,
                   -0.0150,
                    0.0313,
                    0.0090,
                   -0.0103,
                   -0.0040,
                    0.0022,
                    0.0011};
   
    // 20th order, 10Hz cutoff, Fs=1/0.01ms, 80dB atten
    // int order = 21;
    final double[] c4 = {  -0.0012,
                            -0.0030,
                             0.0004,
                             0.0117,
                             0.0150,
                            -0.0128,
                            -0.0538,
                            -0.0335,
                             0.1014,
                             0.2877,
                             0.3765,
                             0.2877,
                             0.1014,
                            -0.0335,
                            -0.0538,
                            -0.0128,
                             0.0150,
                             0.0117,
                             0.0004,
                            -0.0030,
                            -0.0012};
    // 20th order, 5Hz cutoff, Fs=1/0.01ms, 80dB atten
    //int order = 21;
    final double[] c5 = {   0.0010,
                            0.0033,
                            0.0045,
                           -0.0015,
                           -0.0173,
                           -0.0322,
                           -0.0206,
                            0.0396,
                            0.1414,
                            0.2407,
                            0.2822,
                            0.2407,
                            0.1414,
                            0.0396,
                           -0.0206,
                           -0.0322,
                           -0.0173,
                           -0.0015,
                            0.0045,
                            0.0033,
                            0.0010};
    // 20th order, 3Hz cutoff, Fs=1/0.01ms, 80dB atten
    int order = 21;
    final double[] c6 = {   0.0004,
                            0.0005,
                           -0.0018,
                           -0.0087,
                           -0.0178,
                           -0.0184,
                            0.0055,
                            0.0627,
                            0.1424,
                            0.2138,
                            0.2426,
                            0.2138,
                            0.1424,
                            0.0627,
                            0.0055,
                           -0.0184,
                           -0.0178,
                           -0.0087,
                           -0.0018,
                            0.0005,
                            0.0004};
    
    // 50th order, 3Hz cutoff, Fs=1/0.01ms, 80dB atten
    //int order = 51;
    final double[] c7 = {   -0.0001,
                            -0.0002,
                            -0.0002,
                            -0.0000,
                             0.0004,
                             0.0011,
                             0.0020,
                             0.0029,
                             0.0034,
                             0.0031,
                             0.0016,
                            -0.0015,
                            -0.0059,
                            -0.0110,
                            -0.0156,
                            -0.0182,
                            -0.0168,
                            -0.0101,
                             0.0028,
                             0.0220,
                             0.0460,
                             0.0724,
                             0.0982,
                             0.1199,
                             0.1343,
                             0.1394,
                             0.1343,
                             0.1199,
                             0.0982,
                             0.0724,
                             0.0460,
                             0.0220,
                             0.0028,
                            -0.0101,
                            -0.0168,
                            -0.0182,
                            -0.0156,
                            -0.0110,
                            -0.0059,
                            -0.0015,
                             0.0016,
                             0.0031,
                             0.0034,
                             0.0029,
                             0.0020,
                             0.0011,
                             0.0004,
                            -0.0000,
                            -0.0002,
                            -0.0002,
                            -0.0001};  
    // 50th order, 5Hz cutoff, Fs=1/0.01ms, 80dB atten - 10hz too high
    //int order = 51;
    final double[] c8 = {   0.0001,
                            0.0002,
                            0.0001,
                           -0.0002,
                           -0.0008,
                           -0.0015,
                           -0.0020,
                           -0.0019,
                           -0.0005,
                            0.0020,
                            0.0054,
                            0.0082,
                            0.0089,
                            0.0060,
                           -0.0012,
                           -0.0115,
                           -0.0220,
                           -0.0285,
                           -0.0260,
                           -0.0110,
                            0.0175,
                            0.0568,
                            0.1008,
                            0.1413,
                            0.1698,
                            0.1800,
                            0.1698,
                            0.1413,
                            0.1008,
                            0.0568,
                            0.0175,
                           -0.0110,
                           -0.0260,
                           -0.0285,
                           -0.0220,
                           -0.0115,
                           -0.0012,
                            0.0060,
                            0.0089,
                            0.0082,
                            0.0054,
                            0.0020,
                           -0.0005,
                           -0.0019,
                           -0.0020,
                           -0.0015,
                           -0.0008,
                           -0.0002,
                            0.0001,
                            0.0002,
                            0.0001};
    // 100th order, 5Hz
    //int order = 101;
    final double[] c9 = {   0.0001,
                            0.0001,
                            0.0002,
                            0.0003,
                            0.0003,
                            0.0002,
                            0.0000,
                           -0.0002,
                           -0.0005,
                           -0.0008,
                           -0.0010,
                           -0.0010,
                           -0.0009,
                           -0.0004,
                            0.0003,
                            0.0011,
                            0.0019,
                            0.0025,
                            0.0027,
                            0.0024,
                            0.0014,
                           -0.0001,
                           -0.0020,
                           -0.0039,
                           -0.0054,
                           -0.0061,
                           -0.0056,
                           -0.0038,
                           -0.0009,
                            0.0029,
                            0.0069,
                            0.0103,
                            0.0122,
                            0.0119,
                            0.0090,
                            0.0036,
                           -0.0039,
                           -0.0122,
                           -0.0199,
                           -0.0252,
                           -0.0265,
                           -0.0223,
                           -0.0119,
                            0.0045,
                            0.0262,
                            0.0512,
                            0.0771,
                            0.1013,
                            0.1208,
                            0.1336,
                            0.1381,
                            0.1336,
                            0.1208,
                            0.1013,
                            0.0771,
                            0.0512,
                            0.0262,
                            0.0045,
                           -0.0119,
                           -0.0223,
                           -0.0265,
                           -0.0252,
                           -0.0199,
                           -0.0122,
                           -0.0039,
                            0.0036,
                            0.0090,
                            0.0119,
                            0.0122,
                            0.0103,
                            0.0069,
                            0.0029,
                           -0.0009,
                           -0.0038,
                           -0.0056,
                           -0.0061,
                           -0.0054,
                           -0.0039,
                           -0.0020,
                           -0.0001,
                            0.0014,
                            0.0024,
                            0.0027,
                            0.0025,
                            0.0019,
                            0.0011,
                            0.0003,
                           -0.0004,
                           -0.0009,
                           -0.0010,
                           -0.0010,
                           -0.0008,
                           -0.0005,
                           -0.0002,
                            0.0000,
                            0.0002,
                            0.0003,
                            0.0003,
                            0.0002,
                            0.0001,
                            0.0001};
    // 3hz, 100th order
    //int order = 101;
    final double[] c10 = {  -0.0001,
                            -0.0001,
                            -0.0002,
                            -0.0003,
                            -0.0003,
                            -0.0004,
                            -0.0005,
                            -0.0005,
                            -0.0005,
                            -0.0004,
                            -0.0003,
                            -0.0001,
                             0.0002,
                             0.0006,
                             0.0010,
                             0.0015,
                             0.0020,
                             0.0025,
                             0.0029,
                             0.0031,
                             0.0032,
                             0.0030,
                             0.0025,
                             0.0017,
                             0.0005,
                            -0.0009,
                            -0.0026,
                            -0.0045,
                            -0.0064,
                            -0.0083,
                            -0.0099,
                            -0.0111,
                            -0.0117,
                            -0.0116,
                            -0.0106,
                            -0.0086,
                            -0.0054,
                            -0.0011,
                             0.0043,
                             0.0107,
                             0.0179,
                             0.0259,
                             0.0342,
                             0.0426,
                             0.0508,
                             0.0584,
                             0.0651,
                             0.0707,
                             0.0749,
                             0.0775,
                             0.0783,
                             0.0775,
                             0.0749,
                             0.0707,
                             0.0651,
                             0.0584,
                             0.0508,
                             0.0426,
                             0.0342,
                             0.0259,
                             0.0179,
                             0.0107,
                             0.0043,
                            -0.0011,
                            -0.0054,
                            -0.0086,
                            -0.0106,
                            -0.0116,
                            -0.0117,
                            -0.0111,
                            -0.0099,
                            -0.0083,
                            -0.0064,
                            -0.0045,
                            -0.0026,
                            -0.0009,
                             0.0005,
                             0.0017,
                             0.0025,
                             0.0030,
                             0.0032,
                             0.0031,
                             0.0029,
                             0.0025,
                             0.0020,
                             0.0015,
                             0.0010,
                             0.0006,
                             0.0002,
                            -0.0001,
                            -0.0003,
                            -0.0004,
                            -0.0005,
                            -0.0005,
                            -0.0005,
                            -0.0004,
                            -0.0003,
                            -0.0003,
                            -0.0002,
                            -0.0001,
                            -0.0001};    
     // 3hz, 100th order
    //int order = 101;
    final double[] c11 = {  0.0001,
                            0.0001,
                            0.0002,
                            0.0002,
                            0.0003,
                            0.0004,
                            0.0005,
                            0.0006,
                            0.0007,
                            0.0008,
                            0.0009,
                            0.0009,
                            0.0009,
                            0.0007,
                            0.0006,
                            0.0003,
                           -0.0001,
                           -0.0006,
                           -0.0012,
                           -0.0018,
                           -0.0026,
                           -0.0033,
                           -0.0041,
                           -0.0049,
                           -0.0056,
                           -0.0062,
                           -0.0066,
                           -0.0067,
                           -0.0066,
                           -0.0061,
                           -0.0053,
                           -0.0039,
                           -0.0022,
                            0.0001,
                            0.0028,
                            0.0060,
                            0.0097,
                            0.0137,
                            0.0181,
                            0.0227,
                            0.0274,
                            0.0322,
                            0.0369,
                            0.0414,
                            0.0456,
                            0.0494,
                            0.0526,
                            0.0553,
                            0.0572,
                            0.0584,
                            0.0588,
                            0.0584,
                            0.0572,
                            0.0553,
                            0.0526,
                            0.0494,
                            0.0456,
                            0.0414,
                            0.0369,
                            0.0322,
                            0.0274,
                            0.0227,
                            0.0181,
                            0.0137,
                            0.0097,
                            0.0060,
                            0.0028,
                            0.0001,
                           -0.0022,
                           -0.0039,
                           -0.0053,
                           -0.0061,
                           -0.0066,
                           -0.0067,
                           -0.0066,
                           -0.0062,
                           -0.0056,
                           -0.0049,
                           -0.0041,
                           -0.0033,
                           -0.0026,
                           -0.0018,
                           -0.0012,
                           -0.0006,
                           -0.0001,
                            0.0003,
                            0.0006,
                            0.0007,
                            0.0009,
                            0.0009,
                            0.0009,
                            0.0008,
                            0.0007,
                            0.0006,
                            0.0005,
                            0.0004,
                            0.0003,
                            0.0002,
                            0.0002,
                            0.0001,
                            0.0001};   
    // 20th order, 1Hz cutoff, Fs=1/0.01ms, 80dB atten
    //int order = 21;
    final double[] c12 = {  -0.0008,
                            -0.0033,
                            -0.0078,
                            -0.0122,
                            -0.0111,
                             0.0028,
                             0.0347,
                             0.0830,
                             0.1370,
                             0.1798,
                             0.1962,
                             0.1798,
                             0.1370,
                             0.0830,
                             0.0347,
                             0.0028,
                            -0.0111,
                            -0.0122,
                            -0.0078,
                            -0.0033,
                            -0.0008};
    // 20th order, 0.5Hz cutoff, Fs=1/0.01ms, 80dB atten
    //int order = 21;
    final double[] c13 = {  -0.0007,
                            -0.0026,
                            -0.0057,
                            -0.0079,
                            -0.0045,
                             0.0104,
                             0.0404,
                             0.0835,
                             0.1302,
                             0.1667,
                             0.1806,
                             0.1667,
                             0.1302,
                             0.0835,
                             0.0404,
                             0.0104,
                            -0.0045,
                            -0.0079,
                            -0.0057,
                            -0.0026,
                            -0.0007};
        
    
    final double[] c = c13;//c6;  
    
    int i;                  // location in the buffer of newest item
    //int order = 0;
    double[] dat = new double[order];           // data samples

    
    
    /*
    // set up the filter
    public void init(int order)
    {
        // set up the ring buffer
        // All that needs to be done is add a value to a list and then compute the filter 
        // for the whole list. There is no need to "remove" items so the code can be
        // exceptionally simple (read "efficient"). 
        dat = new double[order];
        
        // import any coefficients from external files here
    }
    */
    
    // give it a new sample and receive the latest filtered value
    public double next(double meas)
    {
        double ret = 0;
        
        /*
        // more efficient way
        dat[i] = meas;      // add new measurement
        i++;
        //if(i>order)
        i = i%(order-1);    // loop back to start of array index
        
        //if(i>order-1){i=0;}
        // compute filter
        for(int j=(0+i);(j+i)<(order+i);j++)
        {
            ret += c[j]*dat[j];
        }
        */
        
        // less efficient, but simpler method
        // shift samples
        /*for(int j=0;j<order-1;j++)
        {
            dat[j+1] =dat[j];
        }*/
        System.arraycopy(dat, 0, dat, 1, order-1);
        // add latest sample
        dat[0] = meas;
        // compute filter
        for(int j=0;j<order;j++)
        {
            ret+=dat[j]*c[j];
        }
        
        
        // add some DC gain
        //ret = 2*ret;
        
        
        
        return ret;
    }
}
